<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>××—×©×‘×•×Ÿ ×”×“×¤×¡×”</title><style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --ink:#111; --muted:#6b7280; --line:#e5e7eb;
      --brand:#2563eb; --brand-ink:#fff; --ok:#16a34a; --warn:#c2410c;
      --info-bg:#eff6ff; --info-bd:#bfdbfe; --info-ink:#1e40af;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,'Segoe UI',Arial,Helvetica,sans-serif}
    h1,h2,h3{margin:0 0 8px}
    .wrap{max-width:640px;margin:24px auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 2px 10px #00000010;padding:16px}
    label{display:block;font-weight:600;margin-top:10px}
    select,input[type="number"],button{font-family:inherit;font-size:16px}
    select,input[type="number"]{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
    .row{display:grid;grid-template-columns:1fr 120px 36px;gap:8px;align-items:end}
    .btn{border:none;border-radius:10px;padding:12px 14px;cursor:pointer}
    .btn.brand{background:var(--brand);color:var(--brand-ink);font-weight:700}
    .btn.ghost{background:#fff;border:1px solid var(--line)}
    .btn.icon{width:36px;height:36px;display:grid;place-items:center;border-radius:10px;border:1px solid var(--line);background:#fff}
    .sub{color:var(--muted);font-size:14px}
    .sub-lg{font-size:16px;font-weight:600}
    .rows{display:flex;flex-direction:column;gap:12px;margin-top:8px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .divider{height:1px;background:var(--line);margin:12px 0}
    .summary h3{margin-top:4px}
    .kpi{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));margin:12px 0}
    .pill{border:1px solid var(--line);padding:10px;border-radius:12px;background:#fff}
    .ok{color:var(--ok)}
    .muted{color:var(--muted)}
    .progress{height:16px;background:#e8f5e9;border-radius:999px;position:relative;overflow:hidden}
    .progress>i{position:absolute;inset:0;width:0;background:linear-gradient(90deg,#16a34a,#bbf7d0);}    
    .price-line{display:flex;justify-content:space-between;gap:8px;margin:6px 0}
    .total{display:flex;justify-content:space-between;align-items:baseline;margin:8px 0 10px;font-weight:700}
    .total .mono{font-size:22px}
    .note{font-size:13px;color:var(--muted)}
    .note-lg{font-size:16px}
    .alert{display:flex;gap:8px;align-items:flex-start;color:#dc2626;font-size:16px;font-weight:600}
    .alert .ico{font-size:18px;line-height:1;margin-top:2px}
    .alert .text{font-weight:600}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .mono{font-variant-numeric:tabular-nums}

    .tabs{display:flex;gap:8px;margin-bottom:8px}
    .tab{border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 14px;cursor:pointer}
    .tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}

    .callout{background:var(--info-bg);border:1px solid var(--info-bd);color:var(--info-ink);padding:12px 14px;border-radius:12px;display:flex;gap:8px;align-items:flex-start}
    .callout .ico{font-size:18px;line-height:1;margin-top:2px}

    /* === Mobile tweaks === */
    @media (max-width: 640px){
      .wrap{max-width:560px; padding:12px}
      .tabs{flex-wrap:wrap}
      .tab{flex:1; text-align:center; padding:10px 12px}
      .row{grid-template-columns: 1fr 1fr; align-items:end}
      .row .btn.icon{grid-column: 2; justify-self:end; margin-top:4px}
      label{margin-top:8px}
      select,input[type="number"]{font-size:15px; padding:10px}
      .kpi{grid-template-columns:1fr}
      .pill{padding:8px}
      .progress{height:12px}
      .total .mono{font-size:20px}
    }
    @media (max-width: 380px){
      .wrap{padding:10px}
      .tab{padding:8px 10px}
      .total .mono{font-size:18px}
    }

    @media print{ .toolbar button, #shareWA, #copyQuote{ display:none !important; } body{ background:#fff; } .card{ box-shadow:none; border:none; } }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>××—×©×‘×•×Ÿ ××—×™×¨ ×”×“×¤×¡×”</h1>

    <section class="card">
      <div class="tabs" role="tablist" aria-label="××¦×‘×™ ×—×™×©×•×‘">
        <button id="tabQuick" class="tab active" role="tab" aria-selected="true" aria-controls="panelQuick">××¦×‘ ××”×™×¨</button>
        <button id="tabSeries" class="tab" role="tab" aria-selected="false" aria-controls="panelSeries">××¦×‘ ×¡×“×¨×•×ª</button>
      </div>

      <!-- QUICK MODE -->
      <div id="panelQuick" role="tabpanel" aria-labelledby="tabQuick">
        <div class="toolbar">
          <h2 style="margin-inline-end:auto">×”×“×¤×¡×” ×‘×•×“×“×ª/×§×˜× ×”</h2>
          <button id="resetQuick" class="btn ghost">××™×¤×•×¡ ××”×™×¨</button>
        </div>

        <label>×‘×—×¨×• ×¡×•×’ × ×™×™×¨</label>
        <select id="paperQuick"></select>

        <label>×‘×—×¨×• ×’×•×“×œ</label>
        <select id="sizeQuick"></select>

        <label>×›××•×ª</label>
        <input id="qtyQuick" type="number" min="1" step="1" value="1" />

        <div class="sub">×”××—×™×¨×™× ×›×•×œ×œ×™× ××¢"×.</div>

        <div id="minNoticeQuick" style="margin:10px 0"></div>

        <div id="nearMeter" class="suggest" aria-live="polite" style="display:none;align-items:flex-start;gap:8px;background:#fffbeb;border:1px solid #fde68a;color:#92400e;border-radius:12px;padding:10px 12px;margin:10px 0">
          <span class="ico">âš ï¸</span>
          <div id="nearText"></div>
          <button id="goSeries" class="btn ghost right">×¢×‘×•×¨ ×œ××¦×‘ ×¡×“×¨×•×ª</button>
        </div>

        <div class="divider"></div>
        <div class="callout" id="whyMeterQuick"><span class="ico">â„¹ï¸</span>
          <div>
            <b>×œ××” ××©×ª×œ× ×œ×”×–××™×Ÿ ×œ×¤×—×•×ª 1 ×"×¨?</b><br/>
            ×ª××—×•×¨ ×¤×©×•×˜ ×œ×¤×™ ×©×˜×— ××¦×˜×‘×¨; ×œ×¨×•×‘ <b>××—×™×¨ ×××•×¦×¢ ×œ×™×—×™×“×” × ××•×š ×™×•×ª×¨</b> ×‘×”×–×× ×” ××¨×•×›×–×ª; ×¢×‘×•×“×” ×¨×¦×™×¤×” ×•××—×™×“×” ×œ×”×“×¤×¡×•×ª.
            <div id="reachHintQuick" class="note" style="margin-top:6px"></div>
          </div>
        </div>
      </div>

      <!-- SERIES MODE -->
      <div id="panelSeries" role="tabpanel" aria-labelledby="tabSeries" hidden>
        <div class="toolbar">
          <h2 style="margin-inline-end:auto">×”×–×× ×” ××¨×•×‘×ª ×”×“×¤×¡×•×ª</h2>
          <button id="resetSeries" class="btn ghost">××™×¤×•×¡ ×¡×“×¨×•×ª</button>
        </div>

        <label>×‘×—×¨×• ×¡×•×’ × ×™×™×¨</label>
        <select id="paperSeries"></select>

        <div class="toolbar" style="margin-top:8px">
          <h3 style="margin-inline-end:auto">×©×•×¨×•×ª ×”×”×“×¤×¡×”</h3>
          <button id="addRow" class="btn ghost">+ ×”×•×¡×£ ×©×•×¨×”</button>
        </div>
        <div class="sub">×›×œ ×©×•×¨×” ×”×™× ×‘×—×™×¨×” ××¨×©×™××ª ×”×’×“×œ×™×. ×’×“×œ×™× ×”××¡×•×× ×™× ×‘â€‘<b>*</b> â€“ ××™× ×™××•× ×”×–×× ×” 4 ×™×—×³. (×”××—×™×¨×™× ×›×•×œ×œ×™× ××¢"×)</div>
        <div id="rows" class="rows"></div>

        <div id="minNotice" class="note" style="margin:10px 0"></div>

        <div class="callout"><span class="ico">ğŸ’¡</span>
          <div>
            <b>×˜×™×¤:</b> ××™×—×•×“ ×”×”×“×¤×¡×•×ª ×‘×”×–×× ×” ××—×ª ××§×¨×‘ ××ª×›× ×œâ€‘1 ×"×¨ ×›×š ×©×”×—×™×©×•×‘ ×™×¢×‘×•×¨ ×œ×ª××—×•×¨ ×œ×¤×™ ×©×˜×—.
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- SUMMARY (shared) -->
      <div class="summary">
        <h3 id="summaryTitle">×¡×™×›×•×</h3>
        <div class="kpi">
          <div class="pill">
            <div class="sub">××—×™×¨ ×‘×¡×™×¡ ×œ×"×¨ (×›×•×œ×œ ××¢"×)</div>
            <div class="mono" id="kpiSqmPrice">â€”</div>
            <div class="sub" id="kpiPaperName"></div>
          </div>
          <div class="pill">
            <div class="sub">×¡×”"×› ×©×˜×—</div>
            <div class="mono" id="kpiSqm">0.00 ×"×¨</div>
          </div>
          <div class="pill">
            <div class="sub">×¡×”"×› ×™×—×™×“×•×ª</div>
            <div class="mono" id="kpiUnits">0</div>
          </div>
        </div>
        <div id="progressWrap">
          <div id="progressLabel" class="sub sub-lg" style="margin:8px 0 4px">×”×ª×§×“××•×ª ×œâ€‘1 ×"×¨</div>
          <div class="progress" aria-label='×¡×š ×©×˜×— ××¦×˜×‘×¨'><i id="progressBar"></i></div>
          <div id="progressHint" class="note note-lg" style="margin-top:6px"></div>
        </div>

        <div class="divider"></div>
        <div id="pricesArea"></div>

        <div class="divider"></div>
      </div>
    </section>
  </div>

  <script>
  (function(){
    // ××™×Ÿ × ×¢×™×œ×ª singleton ×›×“×™ ×œ×”×‘×˜×™×— ×©×”×¡×§×¨×™×¤×˜ ×ª××™×“ ×™×¨×•×¥

    // ======= CONFIG =======
    const CONFIG = {
      currency: 'â‚ª',
      sqmDealThreshold: 1, // ×"×¨
      nearPct: 0.90, // ×§×¨×•×‘ ×œ×¡×£ 1 ×"×¨ ×‘××¦×‘ ××”×™×¨
      papers: [
        { id:'enhance-matt', name:'Enhance Matt Paper', pricePerSqm:314 },
        { id:'epson-luster', name:'Epson Premium Luster', pricePerSqm:354 },
        { id:'canson-etching-rag', name:'Canson Etching Rag', pricePerSqm:648 },
        { id:'canson-rag-baryta', name:'Canson Rag Baryta', pricePerSqm:608 },
        { id:'shil-metallic-pearl', name:'Shil Metallic Pearl', pricePerSqm:474 },
      ],
      sizes: [
        ['20Ã—30',20,30,1.8,4], ['25Ã—35',25,35,1.9,4], ['30Ã—40',30,40,1.7,4], ['30Ã—30',30,30,1.7,4], ['30Ã—45',30,45,1.7,4],
        ['35Ã—45',35,45,1.6,4], ['35Ã—50',35,50,1.6,4], ['40Ã—40',40,40,1.6,4], ['40Ã—50',40,50,1.5,4],
        ['40Ã—55',40,55,1.5], ['40Ã—60',40,60,1.5], ['40Ã—65',40,65,1.4], ['50Ã—50',50,50,1.4], ['50Ã—60',50,60,1.4], ['50Ã—70',50,70,1.3],
        ['50Ã—80',50,80,1.3], ['50Ã—90',50,90,1.2], ['50Ã—100',50,100,1.2], ['50Ã—120',50,120,1.2], ['60Ã—60',60,60,1.3],
        ['60Ã—70',60,70,1.2], ['60Ã—80',60,80,1.2], ['60Ã—90',60,90,1.2], ['60Ã—100',60,100,1.1], ['60Ã—120',60,120,1.1],
        ['70Ã—70',70,70,1.2], ['70Ã—80',70,80,1.2], ['70Ã—90',70,90,1.1], ['70Ã—100',70,100,1.1], ['70Ã—120',70,120,1.2],
        ['80Ã—80',80,80,1.1], ['80Ã—100',80,100,1.0], ['80Ã—120',80,120,1.1], ['90Ã—90',90,90,1.2], ['90Ã—100',90,100,1.1],
        ['90Ã—120',90,120,1.1], ['90Ã—140',90,140,1.0], ['100Ã—100',100,100,1.0], ['100Ã—120',100,120,1.0], ['100Ã—130',100,130,1.0],
        ['100Ã—140',100,140,1.0], ['100Ã—150',100,150,1.0], ['100Ã—170',100,170,1.0], ['100Ã—200',100,200,1.0],
      ],
      addons: [],
      bleedCm: 0,
    };

    // ======= STATE =======
    const DEFAULT_STATE = () => ({
      activeTab: 'quick',
      paperIdQuick: 'epson-luster',
      paperIdSeries: 'epson-luster',
      quick: { sizeKey: null, qty: 1 },
      rows: []
    });
    const State = DEFAULT_STATE();

    // ======= UTILS =======
    const el = sel => document.querySelector(sel);
    const fmtCurrency = n => new Intl.NumberFormat('he-IL').format(n);
    const money = n => `${fmtCurrency(n)} ${CONFIG.currency}`;
    const setText = (sel, txt) => { const e = el(sel); if(e) e.textContent = txt; };
    const sqmOf = (w,h) => ((w + CONFIG.bleedCm) * (h + CONFIG.bleedCm)) / 10000;

    const PRESETS = CONFIG.sizes.map(([_,w,h,f,minQty])=>{
      const big = Math.max(w,h), small = Math.min(w,h);
      const key = `${w}x${h}`;
      const star = (minQty && minQty>0) ? ' *' : '';
      return { key, w, h, f, minQty:minQty||0, label:`${big}Ã—${small} ×¡×´×${star}` };
    });
    const PRESET_MAP = Object.fromEntries(PRESETS.map(s=>[s.key,s]));

    const findPaper = (id) => CONFIG.papers.find(p=>p.id===id) || CONFIG.papers[0];

    // === labels with per-unit price ===
    function optionLabel(s, paper){
      const sqm = sqmOf(s.w, s.h);
      const up = Math.round(paper.pricePerSqm * sqm * s.f);
      const big = Math.max(s.w, s.h), small = Math.min(s.w, s.h);
      const star = s.minQty>0 ? ' *' : '';
      return `${big}Ã—${small} ×¡×´×${star} â€” ${fmtCurrency(up)} ${CONFIG.currency} ×œ×™×—×³`;
    }
    function buildQuickSizeOptions(){
      const paper = findPaper(State.paperIdQuick);
      const sel = el('#sizeQuick'); if(!sel) return;
      const opts = PRESETS.map(s=>`<option value="${s.key}">${optionLabel(s,paper)}</option>`).join('');
      sel.innerHTML = opts; sel.value = State.quick.sizeKey;
    }
    function buildSeriesRowOptions(paper){
      return PRESETS.map(s=>`<option value="${s.key}">${optionLabel(s,paper)}</option>`).join('');
    }

    // ======= INIT UI =======
    let __seriesBound = false;
    function initUI(){
      // tabs
      el('#tabQuick').addEventListener('click', ()=> switchTab('quick'));
      el('#tabSeries').addEventListener('click', ()=> switchTab('series'));

      // paper selects
      const paperOpts = CONFIG.papers.map(p=>`<option value="${p.id}">${p.name} (${p.pricePerSqm} ${CONFIG.currency}/×"×¨)</option>`).join('');
      el('#paperQuick').innerHTML = paperOpts;
      el('#paperSeries').innerHTML = paperOpts;
      el('#paperQuick').value = State.paperIdQuick;
      el('#paperSeries').value = State.paperIdSeries;
      el('#paperQuick').addEventListener('change', e=>{ State.paperIdQuick = e.target.value; saveAndRender(); });
      el('#paperSeries').addEventListener('change', e=>{ State.paperIdSeries = e.target.value; saveAndRender(); });

      // quick controls
      if(!State.quick.sizeKey) State.quick.sizeKey = PRESETS[0].key;
      buildQuickSizeOptions();
      el('#sizeQuick').addEventListener('change', e=>{ State.quick.sizeKey = e.target.value; saveAndRender(); });
      el('#qtyQuick').value = State.quick.qty;
      el('#qtyQuick').addEventListener('input', e=>{ State.quick.qty = Math.max(1, Math.round(+e.target.value||1)); e.target.value = State.quick.qty; saveAndRender(); });
      el('#resetQuick').addEventListener('click', ()=>{ State.quick = { sizeKey: PRESETS[0].key, qty: 1 }; State.paperIdQuick='epson-luster'; saveAndRender(); });

      // series controls
      el('#addRow').addEventListener('click', ()=>{ addRow(); saveAndRender(); });
      el('#resetSeries').addEventListener('click', ()=>{ State.rows = []; State.paperIdSeries='epson-luster'; addRow(); saveAndRender(); });

      // bind series events ONCE (×”××–× ×” ×‘×”××¦×œ×”)
      const container = el('#rows');
      if(container && !__seriesBound){
        __seriesBound = true;
        container.addEventListener('change', ev=>{
          const ctrl = ev.target.closest('[data-field]'); if(!ctrl) return;
          const rowEl = ev.target.closest('.row'); if(!rowEl) return;
          const idx = +rowEl.dataset.idx; const field = ctrl.dataset.field;
          if(field==='sizeKey'){ State.rows[idx].sizeKey = ctrl.value; }
          if(field==='qty'){ State.rows[idx].qty = Math.max(1, Math.round(+ctrl.value||1)); ctrl.value = State.rows[idx].qty; }
          saveAndRender();
        });
        // ×ª×’×•×‘×” ××™×™×“×™×ª ×œ×©×™× ×•×™×™ ×›××•×ª (×—×™×¦×™×/×”×§×œ×“×”)
        container.addEventListener('input', ev=>{
          const ctrl = ev.target.closest('[data-field]'); if(!ctrl || ctrl.dataset.field!=='qty') return;
          const rowEl = ev.target.closest('.row'); if(!rowEl) return;
          const idx = +rowEl.dataset.idx;
          State.rows[idx].qty = Math.max(1, Math.round(+ctrl.value||1));
          saveAndRender();
        });
        container.addEventListener('click', ev=>{
          const btn = ev.target.closest('[data-del]'); if(!btn) return;
          const idx = +btn.dataset.del; removeRow(idx); saveAndRender();
        });
      }

      // CTAs
      const goBtn = el('#goSeries'); if(goBtn){ goBtn.addEventListener('click', ()=>{ moveQuickToSeries(); }); }

      if(!State.rows.length){ addRow(); }
      render();
    }

    function switchTab(tab){
      State.activeTab = tab;
      const isQuick = tab==='quick';
      el('#tabQuick').classList.toggle('active', isQuick);
      el('#tabSeries').classList.toggle('active', !isQuick);
      el('#panelQuick').hidden = !isQuick;
      el('#panelSeries').hidden = isQuick;
      saveAndRender();
    }

    function addRow(){ State.rows.push({ sizeKey: PRESETS[0].key, qty: 1 }); }
    function removeRow(idx){ State.rows.splice(idx,1); }

    function rowTemplate(row, idx, paper){
      const sizeOptions = PRESETS.map(s=>`<option value="${s.key}" ${row.sizeKey===s.key?'selected':''}>${optionLabel(s,paper)}</option>`).join('');
      return `
        <div class="row" data-idx="${idx}">
          <div>
            <label>×‘×—×¨×• ×’×•×“×œ</label>
            <select data-field="sizeKey">${sizeOptions}</select>
          </div>
          <div>
            <label>×›××•×ª</label>
            <input class="qty" type="number" min="1" step="1" data-field="qty" value="${row.qty}">
          </div>
          <div>
            <button class="btn icon" title="××—×§" data-del="${idx}">âœ•</button>
          </div>
        </div>`;
    }

    // ======= PRICING ENGINE =======
    function compute(){
      const isQuick = State.activeTab==='quick';
      const paperId = isQuick ? State.paperIdQuick : State.paperIdSeries;
      const paper = findPaper(paperId);

      let rowsRaw = [];
      if(isQuick){
        const s = PRESET_MAP[State.quick.sizeKey] || PRESETS[0];
        const qty = Math.max(1, Math.round(+State.quick.qty||1));
        rowsRaw = [{ key:s.key, w:s.w, h:s.h, f:s.f, minQty:s.minQty, qty }];
      } else {
        rowsRaw = State.rows.map(r=>{ const s=PRESET_MAP[r.sizeKey]||PRESETS[0]; const qty=Math.max(1,Math.round(+r.qty||1)); return { key:s.key,w:s.w,h:s.h,f:s.f,minQty:s.minQty,qty }; });
      }

      const rows = rowsRaw.map(r=>({ ...r, sqm: sqmOf(r.w,r.h), appliedQty:r.qty }));
      // Pre-minimum total sqm BEFORE enforcing starred minimums
      const preMinTotalSqm = rows.reduce((s,r)=> s + r.sqm * r.appliedQty, 0);
      const enforceMinimums = isQuick || preMinTotalSqm < CONFIG.sqmDealThreshold;

      const groupMinMessages = [];
      if(enforceMinimums){
        const groups = new Map();
        rows.forEach((r,i)=>{ if(r.minQty>0){ const k=`${Math.max(r.w,r.h)}x${Math.min(r.w,r.h)}`; if(!groups.has(k)) groups.set(k,[]); groups.get(k).push(i); } });
        for(const [k,idxs] of groups.entries()){
          const m = rows[idxs[0]].minQty;
          const sum = idxs.reduce((s,i)=>s+rows[i].qty,0);
          if(sum < m){
            const uplift = m - sum; rows[idxs[0]].appliedQty += uplift;
            const [big,small] = k.split('x');
            groupMinMessages.push(`×‘×’×•×“×œ ${big}Ã—${small} ×¡×´×: ××™× ×™××•× ×”×–×× ×” ${m} ×™×—×³. ×”××—×™×¨ ×—×•×©×‘ ×œ×¤×™ ${m}.`);
          }
        }
      }

      const totalSqm = rows.reduce((s,r)=> s + r.sqm*r.appliedQty, 0);
      const totalUnits = rows.reduce((s,r)=> s + r.appliedQty, 0);

      const unitItems = rows.map(r=>{ const unitPrice=Math.round(paper.pricePerSqm*r.sqm*r.f); return { ...r, unitPrice, line: unitPrice*r.appliedQty }; });
      const unitSubtotal = unitItems.reduce((s,r)=> s + r.line, 0);
      const sqmSubtotal = Math.round(paper.pricePerSqm * totalSqm);

      const mode = (totalSqm >= CONFIG.sqmDealThreshold) ? 'sqm' : 'unit';
      const productsSubtotal = (mode==='sqm') ? sqmSubtotal : unitSubtotal;
      const grandTotal = isQuick ? unitSubtotal : productsSubtotal;

      let unitsToMeter = null;
      if(State.activeTab==='quick'){
        const s = PRESET_MAP[State.quick.sizeKey] || PRESETS[0];
        const unitSqm = sqmOf(s.w,s.h);
        const missing = Math.max(0, CONFIG.sqmDealThreshold - (unitSqm * (rowsRaw[0]?.qty||1)));
        if(unitSqm>0 && missing>0){ unitsToMeter = Math.ceil(missing / unitSqm); }
      }

      return { isQuick, paper, rows, unitItems, totalSqm, totalUnits, unitSubtotal, sqmSubtotal, mode, productsSubtotal, grandTotal, groupMinMessages, unitsToMeter };
    }

    // ======= ACTIONS =======
    function moveQuickToSeries(){
      const s = PRESET_MAP[State.quick.sizeKey] || PRESETS[0];
      State.rows = [{ sizeKey: s.key, qty: Math.max(1, Math.round(+State.quick.qty||1)) }];
      State.paperIdSeries = State.paperIdQuick;
      switchTab('series');
    }

    // ======= RENDER =======
    function render(){
      const R = compute();

      // series rows UI
      const rowsEl = el('#rows');
      if(rowsEl){ rowsEl.innerHTML = State.rows.map((row,idx)=> rowTemplate(row, idx, findPaper(State.paperIdSeries))).join(''); }

      // sync quick controls UI
      const pq = el('#paperQuick'); if(pq) pq.value = State.paperIdQuick;
      buildQuickSizeOptions();
      const qiq = el('#qtyQuick'); if(qiq) qiq.value = State.quick.qty;

      // shared KPIs
      setText('#kpiSqm', `${R.totalSqm.toFixed(2)} ×"×¨`);
      setText('#kpiUnits', `${R.totalUnits}`);
      setText('#kpiSqmPrice', money(R.paper.pricePerSqm));
      const paperNameEl = el('#kpiPaperName'); if(paperNameEl) paperNameEl.textContent = R.paper.name;

      // progress & hint (hidden in quick mode)
      const pw = el('#progressWrap'); if(pw) pw.style.display = R.isQuick ? 'none' : '';
      const threshold = CONFIG.sqmDealThreshold;
      const bar = el('#progressBar');
      const hint = el('#progressHint');
      if(!R.isQuick){
        const pct = Math.max(0, Math.min(1, R.totalSqm/threshold));
        if(bar) bar.style.width = `${pct*100}%`;
        if(hint) hint.innerHTML = (R.mode==='sqm')
          ? `×”×—×™×©×•×‘ ×œ×¤×™ <b>×"×¨<\/b> ×›×™ ×¢×‘×¨×ª× 1 ×"×¨.`
          : `×¡×”"×› <b>${R.totalSqm.toFixed(2)} ××´×¨</b> â€¢ ×—×¡×¨×™× ×¢×•×“ <b>${(threshold - R.totalSqm).toFixed(2)} ××´×¨</b> ×›×“×™ ×œ×”×’×™×¢ ×œâ€‘1 ×"×¨.`;
      } else {
        if(bar) bar.style.width = '0%';
        if(hint) hint.textContent = '';
      }

      // quick reach hint
      const rh = el('#reachHintQuick'); if(rh){ rh.textContent = (R.isQuick && R.unitsToMeter) ? `×¢×•×“ ${R.unitsToMeter} ×™×—×³ ×‘×’×•×“×œ ×©×‘×—×¨×ª× ×•××ª× ×‘â€‘1 ×"×¨.` : ''; }

      // nearâ€‘meter suggestion (quick)
      const near = el('#nearMeter'); const nearText = el('#nearText');
      if(R.isQuick){
        const nearCond = (R.totalSqm >= CONFIG.nearPct * CONFIG.sqmDealThreshold) ;
        if(nearCond){
          if(near) near.style.display = 'flex';
          if(nearText){
            const over = R.totalSqm >= CONFIG.sqmDealThreshold;
            nearText.textContent = over
              ? '×›××•×ª ×–×• ×¡×‘×™×‘/××¢×œ 1 ×"×¨. ××•××œ×¥ ×œ×¢×‘×•×¨ ×œâ€××¦×‘ ×¡×“×¨×•×ªâ€ ×œ×—×™×©×•×‘ ×œ×¤×™ ×©×˜×— ×•× ×™×”×•×œ ×›××” ×©×•×¨×•×ª.'
              : '××ª× ××ª×§×¨×‘×™× ×œâ€‘1 ×"×¨. ×©×§×œ×• â€××¦×‘ ×¡×“×¨×•×ªâ€ ×›×“×™ ×œ××—×“ ×”×–×× ×” ×•×œ×§×‘×œ ×—×™×©×•×‘ ×œ×¤×™ ×©×˜×—.';
          }
        } else { if(near) near.style.display = 'none'; }
      } else { if(near) near.style.display = 'none'; }

      const minQ = el('#minNoticeQuick'); if(minQ){ minQ.innerHTML = (R.isQuick && R.groupMinMessages.length ? `<div class="alert"><span class="ico">ğŸ’¡</span><div class="text">${R.groupMinMessages.join('<br/>')}</div></div>` : ''); }

      // hide extras in quick mode
      const kpiBox = document.querySelector('.kpi'); if(kpiBox){ kpiBox.style.display = R.isQuick ? 'none' : 'grid'; }
      const quickCallout = el('#whyMeterQuick'); if(quickCallout){ quickCallout.style.display = R.isQuick ? 'none' : ''; }
      const sumTitle = el('#summaryTitle'); if(sumTitle){ sumTitle.style.display = R.isQuick ? 'none' : ''; }

      // total price
      const pricesArea = el('#pricesArea');
      if(pricesArea){
        const totalHtml = `<div class="total"><span>×¡×”"×› ×œ×ª×©×œ×•×</span><span class="mono">${fmtCurrency(R.grandTotal)} ${CONFIG.currency}</span></div>`;
        if(R.isQuick){
          pricesArea.innerHTML = totalHtml; // ×¨×§ ××—×™×¨ ×œ×ª×©×œ×•×
        } else {
          const why = (R.mode==='sqm') ? '×—×•×©×‘ ×œ×¤×™ <b>××´×¨</b>.' : '×—×•×©×‘ <b>×œ×¤×™ ×™×—×™×“×•×ª</b>.';
          pricesArea.innerHTML = totalHtml + `<div class="note note-lg">${why}</div>`;
        }
      }

      // minimums notice (series tab only)
      const minEl = el('#minNotice');
      if(minEl){ minEl.innerHTML = (R.isQuick ? '' : (R.groupMinMessages.length ? `<div class="alert"><span class="ico">ğŸ’¡</span><div class="text">${R.groupMinMessages.join('<br/>')}</div></div>` : '')); }
    }

    // ======= PERSIST & BOOT =======
    function saveAndRender(){ try{ localStorage.setItem('printCalcV2_modes', JSON.stringify(State)); }catch(e){} render(); }

    function load(){
      const saved = localStorage.getItem('printCalcV2_modes');
      if(saved){ try{ Object.assign(State, DEFAULT_STATE(), JSON.parse(saved)||{}); }catch(e){} }
      if(!State.quick.sizeKey) State.quick.sizeKey = PRESETS[0].key;
      if(!State.rows.length) State.rows.push({ sizeKey: PRESETS[0].key, qty: 1 });
    }

    load();
    initUI();
  })();
  </script>
</body>
</html>

</body>
</html>
